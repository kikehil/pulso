generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// Modelo: Usuario (Sistema de Autenticación)
// Nota: SQLite no soporta enums, usamos String con validación en código
model User {
  id           String   @id @default(cuid())
  universityId String
  email        String   @unique
  password     String   // Hash bcrypt
  role         String   @default("ALUMNO") // ADMIN, DOCENTE, ALUMNO, COORDINADOR
  isActive     Boolean  @default(true)
  
  // Relaciones opcionales con perfiles
  teacherId    String?  @unique
  studentId    String?  @unique
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  university    University @relation(fields: [universityId], references: [id], onDelete: Cascade)
  teacher       Teacher? @relation(fields: [teacherId], references: [id])
  student       Student? @relation(fields: [studentId], references: [id])
  notifications Notification[]

  @@index([universityId])
  @@index([role])
  @@map("users")
}

// Modelo principal: Universidad (Tenant)
model University {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logo      String?
  domain    String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  users              User[]
  students           Student[]
  teachers           Teacher[]
  courses            Course[]
  groups             Group[]
  assignments        Assignment[]
  subjects           Subject[]
  attendanceSessions AttendanceSession[]
  rubrics            Rubric[]

  @@map("universities")
}

// Modelo: Estudiante/Alumno
model Student {
  id           String   @id @default(cuid())
  universityId String
  courseId     String?  // Carrera única (single select)
  email        String
  firstName    String
  lastName     String
  enrollmentId String?
  avatarUrl    String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  university        University @relation(fields: [universityId], references: [id], onDelete: Cascade)
  course            Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)
  enrollments       Enrollment[]
  submissions       Submission[]
  studentSubjects   StudentSubject[]
  attendanceRecords AttendanceRecord[]
  user              User?

  @@unique([email, universityId])
  @@index([universityId])
  @@index([courseId])
  @@map("students")
}

// Modelo: Docente
model Teacher {
  id           String   @id @default(cuid())
  universityId String
  email        String
  firstName    String
  lastName     String
  department   String?
  phone        String?
  avatarUrl    String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  university          University @relation(fields: [universityId], references: [id], onDelete: Cascade)
  courses             Course[]
  groups              Group[]
  teacherCareers      TeacherCareer[]
  teacherSubjects     TeacherSubject[]
  assignments         Assignment[]
  attendanceSessions  AttendanceSession[]
  rubrics             Rubric[]
  user                User?

  @@unique([email, universityId])
  @@index([universityId])
  @@map("teachers")
}

// Modelo: Curso/Carrera
model Course {
  id           String   @id @default(cuid())
  universityId String
  teacherId    String?
  name         String
  code         String
  description  String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  university      University @relation(fields: [universityId], references: [id], onDelete: Cascade)
  teacher         Teacher? @relation(fields: [teacherId], references: [id])
  groups          Group[]
  subjects        Subject[]
  teacherCareers  TeacherCareer[]
  students        Student[]

  @@unique([code, universityId])
  @@index([universityId])
  @@map("courses")
}

// Modelo: Materia/Asignatura
model Subject {
  id           String   @id @default(cuid())
  universityId String
  courseId     String
  name         String
  code         String
  credits      Int      @default(0)
  semester     Int?
  description  String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  university          University @relation(fields: [universityId], references: [id], onDelete: Cascade)
  course              Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  groups              Group[] // Nueva relación con grupos
  teacherSubjects     TeacherSubject[]
  studentSubjects     StudentSubject[]
  assignments         Assignment[]
  attendanceSessions  AttendanceSession[]
  schedules           ClassSchedule[]

  @@unique([code, universityId])
  @@index([universityId])
  @@index([courseId])
  @@map("subjects")
}

// Relación muchos a muchos: Teacher - Course (Carreras)
model TeacherCareer {
  id        String   @id @default(cuid())
  teacherId String
  courseId  String
  assignedAt DateTime @default(now())

  // Relaciones
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  course    Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([teacherId, courseId])
  @@index([teacherId])
  @@index([courseId])
  @@map("teacher_careers")
}

// Relación muchos a muchos: Teacher - Subject (Materias)
model TeacherSubject {
  id        String   @id @default(cuid())
  teacherId String
  subjectId String
  assignedAt DateTime @default(now())

  // Relaciones
  teacher   Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([teacherId, subjectId])
  @@index([teacherId])
  @@index([subjectId])
  @@map("teacher_subjects")
}

// Relación muchos a muchos: Student - Subject (Materias)
model StudentSubject {
  id         String   @id @default(cuid())
  studentId  String
  subjectId  String
  enrolledAt DateTime @default(now())

  // Relaciones
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([studentId, subjectId])
  @@index([studentId])
  @@index([subjectId])
  @@map("student_subjects")
}

// Modelo: Grupo
model Group {
  id           String   @id @default(cuid())
  universityId String
  courseId     String
  subjectId    String?  // Nueva relación con Subject (materia)
  name         String
  code         String
  semester     String?
  academicYear String?
  maxStudents  Int?
  schedule     String?
  teacherId    String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)
  course       Course @relation(fields: [courseId], references: [id])
  subject      Subject? @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  teacher      Teacher? @relation(fields: [teacherId], references: [id])
  enrollments  Enrollment[]
  schedules    ClassSchedule[]

  @@unique([code, universityId])
  @@index([universityId])
  @@index([courseId])
  @@index([subjectId])
  @@map("groups")
}

// ============================================
// MÓDULO DE HORARIOS Y CALENDARIO
// ============================================

// Modelo: Horario de Clase
model ClassSchedule {
  id          String   @id @default(cuid())
  subjectId   String
  groupId     String
  teacherId   String   // Para validar permisos
  dayOfWeek   Int      // 0=Domingo, 1=Lunes, 2=Martes, ..., 6=Sábado
  startTime   String   // Formato: "HH:mm" (ej. "10:00")
  endTime     String   // Formato: "HH:mm" (ej. "11:00")
  classroom   String?  // Aula (ej. "C-12")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  subject     Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  group       Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([subjectId])
  @@index([groupId])
  @@index([teacherId])
  @@index([dayOfWeek])
  @@map("class_schedules")
}

// Modelo: Inscripción (relación estudiante-grupo)
model Enrollment {
  id        String   @id @default(cuid())
  studentId String
  groupId   String
  enrolledAt DateTime @default(now())

  // Relaciones
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  group     Group @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([studentId, groupId])
  @@index([studentId])
  @@index([groupId])
  @@map("enrollments")
}

// Modelo: Tarea/Asignación
model Assignment {
  id           String   @id @default(cuid())
  universityId String
  subjectId    String   // Relacionado con Materia
  teacherId    String   // Docente creador
  title        String
  description  String?
  dueDate      DateTime
  maxScore     Int      @default(100)
  rubricId     String?  // Rúbrica asociada (opcional)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)
  subject      Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher      Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  rubric       Rubric? @relation(fields: [rubricId], references: [id])
  submissions  Submission[]

  @@index([universityId])
  @@index([subjectId])
  @@index([teacherId])
  @@index([rubricId])
  @@map("assignments")
}

// Modelo: Entrega de Tarea
model Submission {
  id           String   @id @default(cuid())
  assignmentId String
  studentId    String
  content      String?
  fileUrl      String?
  score        Int?
  feedback     String?
  gradedBy     String?  // ID del docente que calificó
  submittedAt  DateTime @default(now())
  gradedAt     DateTime?

  // Relaciones
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student      Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  rubricGrades RubricGrade[]

  @@unique([assignmentId, studentId])
  @@index([assignmentId])
  @@index([studentId])
  @@map("submissions")
}

// Modelo: Sesión de Asistencia
model AttendanceSession {
  id           String   @id @default(cuid())
  universityId String
  subjectId    String
  teacherId    String
  date         DateTime @default(now())
  notes        String?
  
  // Estadísticas calculadas
  totalStudents      Int      @default(0)
  presentCount       Int      @default(0)
  lateCount          Int      @default(0)
  absentCount        Int      @default(0)
  justifiedCount     Int      @default(0)
  attendancePercent  Float    @default(0)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)
  subject      Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher      Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  records      AttendanceRecord[]

  @@unique([subjectId, date])
  @@index([universityId])
  @@index([subjectId])
  @@index([teacherId])
  @@index([date])
  @@map("attendance_sessions")
}

// Modelo: Registro Individual de Asistencia
model AttendanceRecord {
  id           String   @id @default(cuid())
  sessionId    String
  studentId    String
  status       String   // PRESENTE, RETARDO, FALTA, JUSTIFICADO
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  session      AttendanceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student      Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([sessionId, studentId])
  @@index([sessionId])
  @@index([studentId])
  @@map("attendance_records")
}

// ============================================
// MODELOS DE RÚBRICAS Y EVALUACIÓN
// ============================================

// Modelo: Rúbrica
model Rubric {
  id           String   @id @default(cuid())
  universityId String
  teacherId    String
  title        String
  description  String?
  totalWeight  Float    @default(100) // Peso total en %
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)
  teacher      Teacher @relation(fields: [teacherId], references: [id])
  criteria     RubricCriteria[]
  assignments  Assignment[]

  @@index([universityId])
  @@index([teacherId])
  @@map("rubrics")
}

// Modelo: Criterio de Rúbrica
model RubricCriteria {
  id          String   @id @default(cuid())
  rubricId    String
  description String
  maxPoints   Float    // Puntaje máximo para este criterio
  order       Int      @default(0) // Para ordenar los criterios
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  rubric      Rubric @relation(fields: [rubricId], references: [id], onDelete: Cascade)
  grades      RubricGrade[]

  @@index([rubricId])
  @@map("rubric_criteria")
}

// Modelo: Calificación por Criterio de Rúbrica
model RubricGrade {
  id           String   @id @default(cuid())
  criteriaId   String
  submissionId String
  points       Float    // Puntos otorgados para este criterio
  feedback     String?  // Comentario específico del criterio
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relaciones
  criteria     RubricCriteria @relation(fields: [criteriaId], references: [id], onDelete: Cascade)
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([criteriaId, submissionId])
  @@index([criteriaId])
  @@index([submissionId])
  @@map("rubric_grades")
}

// ============================================
// SISTEMA DE NOTIFICACIONES
// ============================================

// Modelo: Notificación
model Notification {
  id        String   @id @default(cuid())
  userId    String   // Usuario que recibe la notificación
  type      String   // TASK_GRADED, ABSENCE_MARKED, TASK_SUBMITTED, etc.
  title     String
  message   String
  link      String?  // URL para navegar al hacer click
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  // Relaciones
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

